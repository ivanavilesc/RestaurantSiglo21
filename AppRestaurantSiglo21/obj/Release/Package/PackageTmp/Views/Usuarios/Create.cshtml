@model AppRestaurantSiglo21.Models.USUARIO

@{
    ViewBag.Title = "Create";
    Layout = Session["Layout"].ToString();
}

<div class="container">
    <div class="card text-center">
        <div class="card-body">
            <h4>Crear un nuevo usuario</h4>
        </div>
    </div>
    <br />

    @*@using (Html.BeginForm())*@
    @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "createForm" }))
    {
        @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <h4>Nuevo usuario</h4>
        <hr />
        @if (@Session["ErrorMessage"] != null)
        {
            <div class="alert alert-danger" role="alert">
                @Session["ErrorMessage"]
            </div>
            Session.Remove("ErrorMessage");
        }
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-group ">
            <div class="col-10">
                <label for="rutUsuario">RUT</label>
                <input type="text" required oninput="checkRut(this)" class="form-control" id="rutUsuario" name="rutUsuario" placeholder="8 dígitos mas guión, ej: 99999999-9">
            </div>
        </div>
       
        <div class="form-group ">
            <div class="col-10">
                <label for="NOMBRE">Nombre</label>
                <input type="text" required class="form-control" id="NOMBRE" name="NOMBRE" placeholder="ingresa tu nombre">
            </div>
        </div>

        <div class="form-group ">
            <div class="col-10">
                <label for="APELLIDOPATERNO">Apellido</label>
                <input type="text" required class="form-control" id="APELLIDOPATERNO" name="APELLIDOPATERNO" placeholder="ingresa tu apellido paterno">
            </div>
        </div>

        @*<div class="form-group">
            RUT Usuario
            <div class="col-md-10">
                @Html.EditorFor(rutUsuario, new { htmlAttributes = new { @class = "form-control", @required = "required" } })
                @Html.ValidationMessage("rutUsuario", "", new { @class = "text-danger" })
            </div>
        </div>*@

        <div class="form-group">
            @Html.LabelFor(model => model.USERID, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.USERID, new { htmlAttributes = new { @class = "form-control", @required = "required" } })
                @Html.ValidationMessageFor(model => model.USERID, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group ">
            <div class="col-10">
                <label for="PASSWORD">Contraseña</label>
                <input type="password" required class="form-control" id="PASSWORD" name="PASSWORD" placeholder="Utiliza una contraseña segura !!!">
             </div>
        </div>

        <div class="form-group ">
            <div class="col-10">
                <label for="CONFPASSWORD">Repite tu Contraseña</label>
                <input type="password" required class="form-control" id="CONFPASSWORD" name="CONFPASSWORD" placeholder="Utiliza una contraseña segura !!!">
            </div>
        </div>

        @*<div class="form-group">
            @Html.LabelFor(model => model.PASSWORD, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.PasswordFor(model => model.PASSWORD, new { htmlAttributes = new { @class = "form-control", @required = "required" } })
                @Html.ValidationMessageFor(model => model.PASSWORD, "", new { @class = "text-danger" })
            </div>
            <p>Repita contraseña</p>
            <div class="col-md-10">
                @Html.PasswordFor(model => model.PASSWORD, new { htmlAttributes = new { @class = "form-control", @required = "required" } })
                @Html.ValidationMessageFor(model => model.PASSWORD, "", new { @class = "text-danger" })
            </div>

        </div>*@

        <div class="form-group">
            <label for="rutUsuario">Selecciona un ROL</label>
            <div class="col-md-10">
                @Html.DropDownList("ListaRoles", ViewData["LISTAROLES"] as SelectList, "Rol Asignado", new { @class = "form-control required", @name = "Id", @id = "ListaRoles" })
                
            </div>
        </div>

        <div class="form-group">
            <div class="row">
                <div class="col-md-offset-2 col-md-10">
                    <button onclick="ansValidation(event)" type="button" class="btn btn-lg btn-primary btn-block">Guardar</button>

                </div>
            </div>
            <div>

            </div>
        </div>
        <br />
        <br />
        <div> @Html.ActionLink("Volver atrás", "Index", null, new { @class = "btn btn-secondary" })</div>
    </div>
    }


</div>
<script>
    function ansValidation(ev) {
        ev.preventDefault
        // there is no input named name
        //var nameValue = document.getElementById("name").value
        var nameValue = document.getElementById("NOMBRE").value
        var rutValue = document.getElementById("rutUsuario").value
        var passValue = document.getElementById("PASSWORD").value
        var confpassValue = document.getElementById("CONFPASSWORD").value   
        var listaValue = document.getElementById("ListaRoles").value
        // the typeof operator returns a string.
        if (typeof nameValue !== "string") {
            window.alert("Tu nombre tiene un formato inválido")
            // we use strict validation ( !== ) because it's a good practice.
        } else if (rutValue === "") {
            event.preventDefault();
            window.alert("No ingresaste el RUT, este campo es obligatorio !")
        } else if (passValue !== confpassValue) {
            event.preventDefault();
            window.alert("Las contraseñas ingresadas no coinciden, intenta nuevamente !")
        } else if (listaValue === "") {
            event.preventDefault();
            window.alert("No has seleccionado ningún ROL, este campo es obligatorio !!!")
        } else {
            let form = document.getElementById('createForm');
            form.submit()
            
        }
    }
</script>

<script>
    function checkRut(rutUsuario) {
        // Despejar Puntos
        var valor = rutUsuario.value.replace('.', '');
        // Despejar Guión
        valor = valor.replace('-', '');

        // Aislar Cuerpo y Dígito Verificador
        cuerpo = valor.slice(0, -1);
        dv = valor.slice(-1).toUpperCase();

        // Formatear RUN
        rutUsuario.value = cuerpo + '-' + dv

        // Si no cumple con el mínimo ej. (n.nnn.nnn)
        if (cuerpo.length < 7) { rutUsuario.setCustomValidity("RUT Incompleto"); return false; }

        // Calcular Dígito Verificador
        suma = 0;
        multiplo = 2;

        // Para cada dígito del Cuerpo
        for (i = 1; i <= cuerpo.length; i++) {

            // Obtener su Producto con el Múltiplo Correspondiente
            index = multiplo * valor.charAt(cuerpo.length - i);

            // Sumar al Contador General
            suma = suma + index;

            // Consolidar Múltiplo dentro del rango [2,7]
            if (multiplo < 7) { multiplo = multiplo + 1; } else { multiplo = 2; }

        }

        // Calcular Dígito Verificador en base al Módulo 11
        dvEsperado = 11 - (suma % 11);

        // Casos Especiales (0 y K)
        dv = (dv == 'K') ? 10 : dv;
        dv = (dv == 0) ? 11 : dv;

        // Validar que el Cuerpo coincide con su Dígito Verificador
        if (dvEsperado != dv) { rutUsuario.setCustomValidity("RUT Inválido"); return false; }

        // Si todo sale bien, eliminar errores (decretar que es válido)
        rutUsuario.setCustomValidity('');
    }
</script>